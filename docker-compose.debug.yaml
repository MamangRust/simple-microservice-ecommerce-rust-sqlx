services:
  apigateway:
    image: microservice-ecommerce/apigateway:latest
    container_name: simple_ecommerce_apigateway
    restart: unless-stopped
    env_file:
      - ./crates/apigateway/.env
    ports:
      - 5000:5000
    depends_on:
      otel-collector:
        condition: service_started
      auth:
        condition: service_started
      user:
        condition: service_started
      role:
        condition: service_started
      product:
        condition: service_started
      order:
        condition: service_started
      kafka:
        condition: service_healthy
      kafka-topic-creator:
        condition: service_completed_successfully
    volumes:
      - ./logs:/var/log/app
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    networks:
      - app_example_ecommerce

  auth:
    image: microservice-ecommerce/auth:latest
    container_name: simple_ecommerce_auth_service
    restart: unless-stopped
    env_file:
      - ./crates/auth/.env
    ports:
      - 50051:50051
      - 8080:8080
    depends_on:
      user:
        condition: service_started
      pgbouncer:
        condition: service_healthy
      otel-collector:
        condition: service_started
      kafka:
        condition: service_healthy
      kafka-topic-creator:
        condition: service_completed_successfully
    volumes:
      - ./logs:/var/log/app
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    networks:
      - app_example_ecommerce

  user:
    image: microservice-ecommerce/user:latest
    container_name: simple_ecommerce_user_service
    restart: unless-stopped
    env_file:
      - ./crates/user/.env
    ports:
      - 50052:50052
      - 8081:8081
    depends_on:
      role:
        condition: service_started
      pgbouncer:
        condition: service_healthy
      otel-collector:
        condition: service_started
      kafka:
        condition: service_healthy
      kafka-topic-creator:
        condition: service_completed_successfully
    volumes:
      - ./logs:/var/log/app
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    networks:
      - app_example_ecommerce

  role:
    image: microservice-ecommerce/role:latest
    container_name: simple_ecommerce_role_service
    restart: unless-stopped
    env_file:
      - ./crates/role/.env
    ports:
      - 50053:50053
      - 8082:8082
    depends_on:
      pgbouncer:
        condition: service_healthy
      otel-collector:
        condition: service_started
      kafka:
        condition: service_healthy
      kafka-topic-creator:
        condition: service_completed_successfully
    volumes:
      - ./logs:/var/log/app
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    networks:
      - app_example_ecommerce

  product:
    image: microservice-ecommerce/product:latest
    container_name: simple_ecommerce_product_service
    restart: unless-stopped
    env_file:
      - ./crates/product/.env
    ports:
      - 50054:50054
      - 8083:8083
    depends_on:
      pgbouncer:
        condition: service_healthy
      otel-collector:
        condition: service_started
      kafka:
        condition: service_healthy
      kafka-topic-creator:
        condition: service_completed_successfully
    volumes:
      - ./logs:/var/log/app
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    networks:
      - app_example_ecommerce

  order:
    image: microservice-ecommerce/order:latest
    container_name: simple_ecommerce_order_service
    restart: unless-stopped
    env_file:
      - ./crates/order/.env
    ports:
      - 50055:50055
      - 8084:8084
    depends_on:
      product:
        condition: service_started
      pgbouncer:
        condition: service_healthy
      otel-collector:
        condition: service_started
      kafka:
        condition: service_healthy
      kafka-topic-creator:
        condition: service_completed_successfully
    volumes:
      - ./logs:/var/log/app
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    networks:
      - app_example_ecommerce

  email:
    image: microservice-ecommerce/email:latest
    container_name: simple_ecommerce_email_service
    restart: unless-stopped
    env_file:
      - ./crates/email/.env
    depends_on:
      otel-collector:
        condition: service_started
      kafka:
        condition: service_healthy
      kafka-topic-creator:
        condition: service_completed_successfully
    volumes:
      - ./logs:/var/log/app
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    networks:
      - app_example_ecommerce

  redis_apigateway:
    image: redis:7.4
    container_name: redis_apigateway
    ports:
      - "6379:6379"
    volumes:
      - redis_apigateway_data:/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 5
    command: redis-server --requirepass dragon_knight

  redis_auth:
    image: redis:7.4
    container_name: redis_auth
    ports:
      - "6380:6379"
    volumes:
      - redis_auth_data:/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 5
    command: redis-server --requirepass dragon_knight

  redis_orders:
    image: redis:7.4
    container_name: redis_orders
    ports:
      - "6381:6379"
    volumes:
      - redis_orders_data:/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 5
    command: redis-server --requirepass dragon_knight

  redis_products:
    image: redis:7.4
    container_name: redis_products
    ports:
      - "6382:6379"
    volumes:
      - redis_products_data:/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 5
    command: redis-server --requirepass dragon_knight

  redis_role:
    image: redis:7.4
    container_name: redis_role
    ports:
      - "6383:6379"
    volumes:
      - redis_role_data:/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 5
    command: redis-server --requirepass dragon_knight

  redis_users:
    image: redis:7.4
    container_name: redis_users
    ports:
      - "6384:6379"
    volumes:
      - redis_users_data:/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 5
    command: redis-server --requirepass dragon_knight


  postgres_auth:
    image: postgres:17-alpine
    container_name: postgres_auth
    environment:
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_password
      POSTGRES_DB: auth_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_auth_data:/var/lib/postgresql/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U auth_user -d auth_db" ]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres_orders:
    image: postgres:17-alpine
    container_name: postgres_orders
    environment:
      POSTGRES_USER: orders_user
      POSTGRES_PASSWORD: orders_password
      POSTGRES_DB: orders_db
    ports:
      - "5433:5432"
    volumes:
      - postgres_order_data:/var/lib/postgresql/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U orders_user -d orders_db" ]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres_products:
    image: postgres:17-alpine
    container_name: postgres_products
    environment:
      POSTGRES_USER: products_user
      POSTGRES_PASSWORD: products_password
      POSTGRES_DB: products_db
    ports:
      - "5434:5432"
    volumes:
      - postgres_product_data:/var/lib/postgresql/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U products_user -d products_db" ]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres_role:
    image: postgres:17-alpine
    container_name: postgres_role
    environment:
      POSTGRES_USER: role_user
      POSTGRES_PASSWORD: role_password
      POSTGRES_DB: role_db
    ports:
      - "5435:5432"
    volumes:
      - postgres_role_data:/var/lib/postgresql/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U role_user -d role_db" ]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres_users:
    image: postgres:17-alpine
    container_name: postgres_users
    environment:
      POSTGRES_USER: users_user
      POSTGRES_PASSWORD: users_password
      POSTGRES_DB: users_db
    ports:
      - "5436:5432"
    volumes:
      - postgres_user_data:/var/lib/postgresql/data
    networks:
      - app_example_ecommerce
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U users_user -d users_db" ]
      interval: 5s
      timeout: 5s
      retries: 5

  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: pgbouncer
    ports:
      - "6432:6432"
      - "6433:6433"
    volumes:
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro
      - ./pgbouncer/init.sh:/docker-entrypoint-initdb.d/init.sh:ro
      - ./pgbouncer/health-check.sh:/usr/local/bin/health-check.sh:ro
      - ./pgbouncer/manage.sh:/usr/local/bin/manage.sh:ro
      - pgbouncer_logs:/var/log/pgbouncer
      - pgbouncer_data:/var/lib/pgbouncer
    networks:
      - app_example_ecommerce
    depends_on:
      postgres_auth:
        condition: service_healthy
      postgres_orders:
        condition: service_healthy
      postgres_products:
        condition: service_healthy
      postgres_role:
        condition: service_healthy
      postgres_users:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "/usr/local/bin/health-check.sh" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    environment:
      - PGBOUNCER_ADMIN_USER=admin
      - PGBOUNCER_ADMIN_PASS=admin_password
      - PGBOUNCER_STATS_USER=stats
      - PGBOUNCER_STATS_PASS=stats_password
    command: [ "pgbouncer", "/etc/pgbouncer/pgbouncer.ini" ]

  kafka:
    image: apache/kafka:latest
    container_name: simple_ecommerce_kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_LOG_DIRS: /tmp/kraft-combined-logs
      KAFKA_CLUSTER_ID: kraft-cluster-01
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    networks:
      - app_example_ecommerce
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  kafka-topic-creator:
    image: apache/kafka:latest
    container_name: simple_ecommerce_kafka_topic_creator
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - ./create_topic.sh:/tmp/create_topic.sh:ro
    command: ["/bin/sh", "/tmp/create_topic.sh"]
    networks:
      - app_example_ecommerce

  node-exporter:
    image: prom/node-exporter:latest
    container_name: simple_ecommerce_node_exporter
    restart: unless-stopped
    command:
      - '--path.rootfs=/host'
    volumes:
      - '/:/host:ro,rslave'
    networks:
      - app_example_ecommerce

  prometheus:
    image: prom/prometheus
    container_name: simple_ecommerce_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    restart: unless-stopped
    networks:
      - app_example_ecommerce

  grafana:
    image: grafana/grafana:latest
    container_name: simple_ecommerce_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana_example_ecommerce-tonic-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
    restart: unless-stopped
    networks:
      - app_example_ecommerce

  jaeger:
    image: jaegertracing/all-in-one:1.74.0
    container_name: simple_ecommerce_jaeger
    ports:
      - "16686:16686"
      - "14250:14250"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    restart: unless-stopped
    networks:
      - app_example_ecommerce

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: simple_ecommerce_otel_collector
    ports:
      - "4317:4317"
      - "4318:4318"
      - "13133:13133"
      - "8889:8889"
    volumes:
      - ./observability/otel-collector.yaml:/etc/otel-collector-config.yaml:ro
    command: ["--config=/etc/otel-collector-config.yaml"]
    restart: unless-stopped
    networks:
      - app_example_ecommerce

  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: simple_ecommerce_alertmanager
    volumes:
      - ./observability/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
    ports:
      - "9093:9093"
    networks:
      - app_example_ecommerce

  loki:
    container_name: simple_ecommerce_loki
    image: grafana/loki:3.5.8
    ports:
      - "3100:3100"
    volumes:
      - ./observability/loki-config.yaml:/etc/loki/local-config.yaml
      - loki_example_ecommerce_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - app_example_ecommerce

  promtail:
    container_name: simple_ecommerce_promtail
    image: grafana/promtail:2.9.0
    volumes:
      - ./observability/promtail-config.yaml:/etc/promtail/config.yaml
      - ./logs:/var/log/app
    command: -config.file=/etc/promtail/config.yaml
    networks:
      - app_example_ecommerce

networks:
  app_example_ecommerce:
    driver: bridge

volumes:
  grafana_example_ecommerce-tonic-data:
  postgres_auth_data:
  postgres_user_data:
  postgres_role_data:
  postgres_product_data:
  postgres_order_data:
  postgres_email_data:
  redis_apigateway_data:
  redis_auth_data:
  redis_orders_data:
  redis_products_data:
  redis_role_data:
  redis_users_data:
  loki_example_ecommerce_data:
  kafka_data_ecommerce_data:
  pgbouncer_logs:
  pgbouncer_data: